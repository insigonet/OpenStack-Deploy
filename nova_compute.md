# Инструкция по изменению пути хранения данных виртуальных машин в OpenStack Kolla-Ansible

Данная инструкция подробно описывает, как настроить OpenStack с использованием Kolla-Ansible для хранения данных виртуальных машин на определенном диске или разделе, например, `/mnt/md0/nova`. Инструкция включает в себя проверку пользователя, под которым работает контейнер `nova_compute`, создание необходимых директорий, настройку переменных Ansible и подробное объяснение принципов работы, включая ссылки на файлы конфигурации и команды для отображения параметров.

## Содержание

1. [Введение](#введение)
2. [Шаг 1: Проверка пользователя контейнера `nova_compute`](#шаг-1-проверка-пользователя-контейнера-nova_compute)
3. [Шаг 2: Создание директории для данных Nova](#шаг-2-создание-директории-для-данных-nova)
4. [Шаг 3: Настройка прав доступа на директорию](#шаг-3-настройка-прав-доступа-на-директорию)
5. [Шаг 4: Обновление конфигурации Kolla-Ansible](#шаг-4-обновление-конфигурации-kolla-ansible)
6. [Шаг 5: Применение изменений и проверка](#шаг-5-применение-изменений-и-проверка)
7. [Объяснение работы переменной `nova_instance_datadir`](#объяснение-работы-переменной-nova_instance_datadir)
    - [Где она определена](#где-она-определена)
    - [Как просмотреть значения переменных](#как-просмотреть-значения-переменных)
    - [Демонстрации в других местах](#демонстрации-в-других-местах)
8. [Заключение](#заключение)

## Введение

В OpenStack сервис Nova отвечает за управление экземплярами виртуальных машин. По умолчанию данные виртуальных машин хранятся в директории `/var/lib/nova/instances` внутри контейнера `nova_compute`. Цель этой инструкции — изменить путь хранения данных виртуальных машин на другой диск или раздел, например, RAID-массив, смонтированный в `/mnt/md0`.

## Шаг 1: Проверка пользователя контейнера `nova_compute`

Перед настройкой необходимо определить UID и GID пользователя, под которым работает процесс Nova внутри контейнера `nova_compute`.

### Действия

1. **Проверьте список запущенных контейнеров:**

   ```bash
   docker ps
   ```

   Убедитесь, что контейнер `nova_compute` запущен.

2. **Определите UID и GID пользователя `nova` внутри контейнера:**

   ```bash
   docker exec nova_compute id nova
   ```

   **Ожидаемый результат:**

   ```
   uid=42436(nova) gid=42436(nova) groups=42436(nova)
   ```

   Это означает, что пользователь `nova` имеет UID и GID `42436`.

## Шаг 2: Создание директории для данных Nova

Создадим директорию на вашем диске или разделе, где будут храниться данные виртуальных машин.

### Действия

1. **Создайте директорию:**

   ```bash
   sudo mkdir -p /mnt/md0/nova
   ```

2. **Убедитесь, что диск или раздел `/mnt/md0` смонтирован и доступен.**

## Шаг 3: Настройка прав доступа на директорию

Для корректной работы сервисов Nova необходимо установить правильные права доступа и владельца на директорию `/mnt/md0/nova`.

### Действия

1. **Установите владельца и группу директории на UID и GID пользователя `nova`:**

   ```bash
   sudo chown -R 42436:42436 /mnt/md0/nova
   ```

   Это назначит владельцем и группой директории пользователя с UID и GID `42436`, соответствующего пользователю `nova` внутри контейнера.

2. **Установите правильные права доступа:**

   ```bash
   sudo chmod 750 /mnt/md0/nova
   ```

   Это даст следующие права доступа:

   - **Владелец (nova):** чтение, запись, выполнение.
   - **Группа:** чтение и выполнение.
   - **Остальные:** нет доступа.

3. **(Опционально) Создайте пользователя и группу `nova` на хосте для удобства:**

   ```bash
   sudo groupadd -g 42436 nova
   sudo useradd -u 42436 -g nova nova
   ```

   Это позволит видеть имя пользователя и группы при просмотре прав доступа на хосте.

## Шаг 4: Обновление конфигурации Kolla-Ansible

Необходимо обновить файл глобальной конфигурации Kolla-Ansible, чтобы указать новый путь для хранения данных виртуальных машин.

### Действия

1. **Откройте файл `/etc/kolla/globals.yml` для редактирования:**

   ```bash
   sudo nano /etc/kolla/globals.yml
   ```

2. **Добавьте или измените следующую строку:**

   ```yaml
   nova_instance_datadir: "/mnt/md0/nova"
   ```

   Это указывает Kolla-Ansible использовать `/mnt/md0/nova` в качестве директории для хранения данных экземпляров.

3. **Удалите или закомментируйте строку, если она есть:**

   ```yaml
   # nova_instance_datadir_volume: "/some/path"
   ```

   **Важно:** Не переопределяйте `nova_instance_datadir_volume`, чтобы избежать возможных несоответствий.

4. **Сохраните и закройте файл.**

## Шаг 5: Применение изменений и проверка

После обновления конфигурации необходимо применить изменения и убедиться, что все работает корректно.

### Действия

1. **Активируйте виртуальное окружение и загрузите переменные окружения OpenStack (если требуется):**

   ```bash
   source ~/venv/bin/activate
   source ~/admin-openrc.sh
   ```

2. **Примените изменения с помощью Kolla-Ansible:**

   ```bash
   kolla-ansible -i /path/to/your/inventory reconfigure
   ```

   Замените `/path/to/your/inventory` на путь к вашему инвентарному файлу Ansible.

3. **Перезапустите контейнеры Nova (если необходимо):**

   Если контейнеры не перезапустились автоматически, вы можете перезапустить их вручную:

   ```bash
   docker restart nova_compute
   docker restart nova_libvirt
   ```

4. **Проверьте, что монтирование выполнено корректно:**

   ```bash
   docker inspect -f '{{ range .Mounts }}{{ .Source }} -> {{ .Destination }}{{ "\n" }}{{ end }}' nova_compute
   ```

   **Ожидаемый результат:**

   ```
   /mnt/md0/nova -> /var/lib/nova
   ```

   Это означает, что директория `/mnt/md0/nova` на хосте монтируется в контейнере как `/var/lib/nova`.

5. **Проверьте доступность директории внутри контейнера:**

   ```bash
   docker exec -it nova_compute bash
   ls -ld /var/lib/nova
   ```

   Убедитесь, что директория принадлежит пользователю `nova` и имеет правильные права доступа.

6. **Проверьте возможность записи:**

   Внутри контейнера попробуйте создать файл:

   ```bash
   touch /var/lib/nova/test_file
   ls /var/lib/nova/test_file
   rm /var/lib/nova/test_file
   ```

   Если операции проходят без ошибок, значит права доступа настроены правильно.

## Объяснение работы переменной `nova_instance_datadir`

### Что такое `nova_instance_datadir`?

Переменная `nova_instance_datadir` в Kolla-Ansible определяет путь на **хосте**, где будут храниться данные экземпляров Nova (виртуальных машин). По умолчанию она установлена в `/var/lib/nova`.

### Где она определена?

1. **Глобальная конфигурация:**

   Вы можете определить `nova_instance_datadir` в вашем файле глобальных переменных Kolla-Ansible, обычно это `/etc/kolla/globals.yml`.

2. **Переменные по умолчанию в роли Nova:**

   Внутри ролей Ansible для Nova переменная `nova_instance_datadir_volume` определяется следующим образом:

   ```yaml
   nova_instance_datadir_volume: "{{ nova_instance_datadir }}"
   ```

   **Файл, где это определено:**

   ```
   /usr/local/share/kolla-ansible/ansible/roles/nova-cell/defaults/main.yml
   ```

   Этот путь может отличаться в зависимости от места установки Kolla-Ansible на вашем сервере. В вашем случае, если вы используете виртуальное окружение, путь может быть:

   ```
   ~/venv/share/kolla-ansible/ansible/roles/nova-cell/defaults/main.yml
   ```

   **Пример команды для просмотра:**

   ```bash
   cat ~/venv/share/kolla-ansible/ansible/roles/nova-cell/defaults/main.yml | grep nova_instance_datadir_volume
   ```

   **Ожидаемый результат:**

   ```yaml
   nova_instance_datadir_volume: "{{ nova_instance_datadir }}"
   ```

### Как это работает?

1. **Связь переменных:**

   - `nova_instance_datadir_volume` получает значение из `nova_instance_datadir`.
   - Это обеспечивает единообразие между местом хранения данных на хосте и тем, что монтируется в контейнер.

2. **Использование в монтировании томов:**

   В файле конфигурации контейнера `nova_compute`, переменная `nova_compute_default_volumes` используется для определения монтирования:

   ```yaml
   nova_compute_default_volumes:
     - "{{ nova_instance_datadir_volume }}:/var/lib/nova/"
   ```

   **Файл, где это определено:**

   ```
   /usr/local/share/kolla-ansible/ansible/roles/nova-cell/defaults/main.yml
   ```

   **Пример команды для просмотра:**

   ```bash
   grep -A 2 'nova_compute_default_volumes' ~/venv/share/kolla-ansible/ansible/roles/nova-cell/defaults/main.yml
   ```

   **Ожидаемый результат:**

   ```yaml
   nova_compute_default_volumes:
     - "{{ node_config_directory }}/nova-compute/:{{ container_config_directory }}/:ro"
     - ...
     - "{{ nova_instance_datadir_volume }}:/var/lib/nova/"
   ```

3. **Влияние на контейнер:**

   Это означает, что директория на хосте, указанная в `nova_instance_datadir`, будет смонтирована в контейнере `nova_compute` по пути `/var/lib/nova`. Таким образом, сервис Nova внутри контейнера будет использовать этот путь для хранения данных экземпляров.

### Как просмотреть значения переменных?

Вы можете использовать команды Ansible для отображения значений переменных:

1. **Создайте тестовый плейбук `show_vars.yml`:**

   ```yaml
   - hosts: localhost
     gather_facts: no
     vars_files:
       - /etc/kolla/globals.yml
       - ~/venv/share/kolla-ansible/ansible/roles/nova-cell/defaults/main.yml
     tasks:
       - debug:
           msg:
             - "nova_instance_datadir: {{ nova_instance_datadir }}"
             - "nova_instance_datadir_volume: {{ nova_instance_datadir_volume }}"
   ```

2. **Запустите плейбук:**

   ```bash
   ansible-playbook show_vars.yml
   ```

   **Ожидаемый результат:**

   ```
   TASK [debug] ****************************************************************
   ok: [localhost] => {
       "msg": [
           "nova_instance_datadir: /mnt/md0/nova",
           "nova_instance_datadir_volume: /mnt/md0/nova"
       ]
   }
   ```

   Это показывает, что переменная `nova_instance_datadir_volume` имеет значение, которое вы задали в `nova_instance_datadir`.

### Демонстрации в других местах

**Поиск определения переменной в файлах:**

Вы можете использовать команду `grep` для поиска определения переменной в файлах ролей Ansible:

```bash
grep -rnw '~/venv/share/kolla-ansible/ansible/roles/' -e 'nova_instance_datadir_volume'
```

**Ожидаемый результат:**

```
~/venv/share/kolla-ansible/ansible/roles/nova-cell/defaults/main.yml: nova_instance_datadir_volume: "{{ nova_instance_datadir }}"
```

**Просмотр всех переменных для роли Nova:**

Вы можете использовать Ansible для вывода всех переменных, используемых в роли `nova-cell`:

1. **Создайте плейбук `list_vars.yml`:**

   ```yaml
   - hosts: localhost
     gather_facts: no
     vars_files:
       - /etc/kolla/globals.yml
       - ~/venv/share/kolla-ansible/ansible/roles/nova-cell/defaults/main.yml
     tasks:
       - debug:
           var: vars
   ```

2. **Запустите плейбук:**

   ```bash
   ansible-playbook list_vars.yml
   ```

   Это выведет все переменные, используемые в роли, включая `nova_instance_datadir` и `nova_instance_datadir_volume`.

## Заключение

В этой инструкции мы подробно рассмотрели процесс переноса хранения данных виртуальных машин Nova на другой диск или раздел в OpenStack с использованием Kolla-Ansible. Мы узнали, как:

- Определить пользователя, под которым работает сервис Nova.
- Создать необходимую директорию и настроить правильные права доступа.
- Обновить конфигурацию Kolla-Ansible, используя переменную `nova_instance_datadir`.
- Понять, где и как определяются переменные `nova_instance_datadir` и `nova_instance_datadir_volume`.
- Использовать команды для просмотра и проверки значений переменных.
- Применить изменения и убедиться, что все работает корректно.

Эта информация поможет вам и вашим коллегам лучше понять принципы работы OpenStack и Kolla-Ansible, а также настроить систему в соответствии с вашими потребностями.

---

**Примечание:** Всегда рекомендуется иметь резервные копии ваших данных перед внесением существенных изменений в конфигурацию системы. Убедитесь, что у вас есть план восстановления на случай непредвиденных ситуаций.
